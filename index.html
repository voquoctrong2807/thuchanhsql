<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Master - H∆∞·ªõng D·∫´n Th·ª±c H√†nh CSDL (Interactive)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- AlaSQL (SQL Engine in JS) -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@1.7.3/dist/alasql.min.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Scrollbars */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Code Theme */
        .code-block { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; line-height: 1.6; font-size: 13px; }
        .sql-kw { color: #569cd6; font-weight: bold; } 
        .sql-str { color: #ce9178; } 
        .sql-fn { color: #dcdcaa; } 
        .sql-com { color: #6a9955; font-style: italic; } 

        /* Visualizations */
        .table-visual { border: 1px solid #cbd5e1; border-radius: 6px; background: white; overflow: hidden; min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-header { background: #f1f5f9; padding: 6px; font-weight: 700; text-align: center; border-bottom: 1px solid #cbd5e1; font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; }
        .table-row { padding: 5px 8px; font-size: 11px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .pk-badge { background: #fef08a; color: #854d0e; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: bold; }
        
        .venn-container { position: relative; width: 180px; height: 120px; margin: 0 auto; }
        .venn-circle { position: absolute; width: 90px; height: 90px; border-radius: 50%; opacity: 0.6; mix-blend-mode: multiply; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 12px; transition: transform 0.3s; }
        .venn-a { background: #6366f1; left: 20px; top: 15px; } 
        .venn-b { background: #ec4899; right: 20px; top: 15px; } 
        
        .flow-node { border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; background: white; font-size: 11px; font-weight: 600; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }

        /* UI Elements */
        .nav-item.active { background-color: #eff6ff; color: #4f46e5; border-right: 3px solid #4f46e5; font-weight: 600; }
        .tab-btn.active { background-color: white; color: #4338ca; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: 600; }
        .ai-explanation-box { display: none; margin-top: 12px; padding: 16px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; font-size: 0.9rem; color: #166534; line-height: 1.6; }
        .concept-note { font-size: 0.85rem; color: #64748b; line-height: 1.5; margin-bottom: 8px; }

        /* SQL Result Table Style */
        .sql-result-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .sql-result-table th { background-color: #f1f5f9; text-align: left; padding: 8px; border: 1px solid #e2e8f0; font-weight: 600; color: #475569; }
        .sql-result-table td { padding: 8px; border: 1px solid #e2e8f0; color: #334155; }
        .sql-result-table tr:nth-child(even) { background-color: #f8fafc; }
        .sql-result-table tr:hover { background-color: #f0f9ff; }

        /* --- PRINT CSS (T·ªêI ∆ØU CHO PDF) --- */
        @media print {
            @page { margin: 1.5cm; size: A4; }
            body { background: white !important; color: black !important; overflow: visible !important; height: auto !important; font-family: 'Inter', sans-serif; }
            
            /* ·∫®n c√°c th√†nh ph·∫ßn kh√¥ng c·∫ßn thi·∫øt khi in */
            /* C·∫≠p nh·∫≠t: Th√™m #demo v√† .ai-explanation-box v√†o danh s√°ch ·∫©n */
            #sidebar, .no-print, #ai-fab, #toast, .ai-btn, #chat-modal, #settings-modal, .mobile-header, .tab-buttons-container, #demo, .ai-explanation-box { 
                display: none !important; 
            }

            /* Layout in ·∫•n */
            #main-content { 
                margin: 0 !important; 
                padding: 0 !important; 
                width: 100% !important; 
                height: auto !important; 
                overflow: visible !important; 
            }

            /* Bung t·∫•t c·∫£ c√°c tab v√† n·ªôi dung ·∫©n */
            .content-section, .tab-content, .ddl-content, .dml-content, .hidden { 
                display: block !important; 
                opacity: 1 !important;
                visibility: visible !important;
                height: auto !important;
            }

            .no-print { display: none !important; }
            .print\:block { display: block !important; }

            /* Ng·∫Øt trang & B·ªë c·ª•c */
            .content-section { page-break-after: always; margin-bottom: 2cm; padding-bottom: 20px; border-bottom: 1px solid #eee; }
            .content-section:last-child { page-break-after: auto; border-bottom: none; }
            
            .code-block, .table-visual, .venn-container, .flow-node, .grid { 
                break-inside: avoid; 
                page-break-inside: avoid;
            }

            /* Gi·ªØ m√†u s·∫Øc */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .code-block { border: 1px solid #ccc !important; background-color: #f3f4f6 !important; color: #111 !important; box-shadow: none !important; }
            
            /* Ti√™u ƒë·ªÅ cho c√°c ph·∫ßn tab b·ªã ·∫©n n√∫t b·∫•m */
            .ddl-content::before, .dml-content::before {
                content: attr(id); 
                display: block;
                font-weight: bold;
                font-size: 1.2em;
                margin-top: 2em;
                margin-bottom: 0.5em;
                text-transform: uppercase;
                color: #4338ca;
                border-bottom: 2px solid #e5e7eb;
            }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-col h-full hidden md:flex z-40 transition-all duration-300 shadow-xl md:shadow-none shrink-0">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h1 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                <span class="material-symbols-outlined filled">database</span> SQL Master
            </h1>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-1 custom-scroll">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-2 pl-2">1. Ng√¥n ng·ªØ SQL</div>
            <button onclick="scrollToSection('ddl')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">table_view</span> 1.1 ƒê·ªãnh nghƒ©a DL (DDL)
            </button>
            <button onclick="scrollToSection('dml')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">query_stats</span> 1.2 Thao t√°c DL (DML)
            </button>
            <button onclick="scrollToSection('triggers')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">bolt</span> 1.3 Trigger
            </button>
            <button onclick="scrollToSection('demo')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-indigo-600 font-bold bg-indigo-50 border-r-4 border-indigo-600">
                <span class="material-symbols-outlined text-lg">terminal</span> 1.4 SQL Live Demo
            </button>
            
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6 pl-2">2. L√Ω thuy·∫øt thi·∫øt k·∫ø</div>
            <button onclick="scrollToSection('keys')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">key</span> 2.1 T√¨m Kho√° (Bao ƒë√≥ng)
            </button>
            <button onclick="scrollToSection('normalization')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">checklist</span> 2.2 D·∫°ng chu·∫©n (NF)
            </button>
            <button onclick="scrollToSection('decomposition')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm transition-colors text-slate-600">
                <span class="material-symbols-outlined text-lg">call_split</span> 2.3 Ph√¢n r√£ (PTT)
            </button>
        </nav>
        <div class="p-4 border-t border-slate-100 bg-slate-50 space-y-2 no-print">
            <button onclick="window.print()" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white text-sm font-medium py-2.5 px-4 rounded hover:bg-indigo-700 transition shadow-md mb-2">
                <span class="material-symbols-outlined text-sm">picture_as_pdf</span> Xu·∫•t PDF
            </button>
            <button onclick="openSettings()" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-300 text-slate-700 text-sm font-medium py-2 px-4 rounded hover:bg-slate-100 transition">
                <span class="material-symbols-outlined text-sm">settings</span> C√†i ƒë·∫∑t API Key
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 h-full overflow-y-auto bg-slate-50/50 p-4 md:p-8 relative w-full scroll-smooth">
        
        <!-- Mobile Toggle -->
        <div class="md:hidden flex items-center justify-between mb-6 no-print mobile-header">
            <h1 class="text-lg font-bold text-indigo-700 flex items-center gap-2">SQL Master</h1>
            <div class="flex gap-2">
                <button class="p-2 bg-indigo-50 text-indigo-700 rounded shadow-sm" onclick="window.print()"><span class="material-symbols-outlined">print</span></button>
                <button class="p-2 bg-white rounded shadow text-slate-600" onclick="document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('w-full');">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
        </div>

        <!-- 1.4 SQL LIVE DEMO SECTION -->
        <section id="demo" class="content-section max-w-6xl mx-auto mb-16 animate-fade-in block">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg shadow-indigo-200"><span class="material-symbols-outlined">terminal</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">1.4 SQL Live Demo (Th·ª±c h√†nh)</h2>
                    <p class="text-slate-500 text-sm">Ch·∫°y th·ª≠ c√°c c√¢u l·ªánh SQL tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát v·ªõi d·ªØ li·ªáu m·∫´u ho·∫∑c CSDL c·ªßa b·∫°n.</p>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6 h-[calc(100vh-200px)] min-h-[500px]">
                
                <!-- LEFT: Schema Viewer (Dynamic) -->
                <div class="bg-white border border-slate-200 rounded-xl flex flex-col shadow-sm overflow-hidden">
                    <!-- DB Control Header (UPDATED with Switcher) -->
                    <div class="p-3 bg-slate-50 border-b border-slate-200 text-sm flex flex-col gap-2">
                        <div class="flex justify-between items-center bg-white border border-slate-200 rounded px-2 py-1">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <span class="material-symbols-outlined text-indigo-600 text-sm shrink-0">database</span>
                                <select id="db-selector" onchange="switchDB(this.value)" class="bg-transparent font-bold text-indigo-900 text-xs outline-none cursor-pointer w-full truncate" title="Chuy·ªÉn ƒë·ªïi CSDL">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="createNewDB()" class="flex-1 bg-white border border-slate-300 rounded text-[10px] font-bold text-slate-600 py-1.5 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-300 transition flex items-center justify-center gap-1" title="T·∫°o CSDL M·ªõi">
                                <span class="material-symbols-outlined text-[12px]">add</span> M·ªõi
                            </button>
                            <button onclick="triggerImport()" class="flex-1 bg-white border border-slate-300 rounded text-[10px] font-bold text-slate-600 py-1.5 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-300 transition flex items-center justify-center gap-1" title="Nh·∫≠p file SQL">
                                <span class="material-symbols-outlined text-[12px]">upload</span> Nh·∫≠p
                            </button>
                            <button onclick="exportDB()" class="flex-1 bg-white border border-slate-300 rounded text-[10px] font-bold text-slate-600 py-1.5 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-300 transition flex items-center justify-center gap-1" title="Xu·∫•t file SQL">
                                <span class="material-symbols-outlined text-[12px]">download</span> Xu·∫•t
                            </button>
                            <input type="file" id="import-file" class="hidden" accept=".sql" onchange="handleFileImport(this)">
                        </div>
                    </div>
                    
                    <!-- Dynamic Table List -->
                    <div id="schema-container" class="p-3 space-y-3 overflow-y-auto flex-1 custom-scroll">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>

                <!-- RIGHT: Editor & Result -->
                <div class="lg:col-span-2 flex flex-col gap-4 h-full">
                    
                    <!-- NEW: AI Demo Assistant -->
                    <div class="bg-gradient-to-r from-indigo-50 to-white p-4 rounded-xl border border-indigo-100 shadow-sm flex flex-col gap-3 relative overflow-hidden group no-print">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-100 rounded-bl-full -mr-8 -mt-8 z-0 opacity-50"></div>
                        <div class="flex items-center gap-2 z-10">
                            <span class="material-symbols-outlined text-indigo-600">auto_awesome</span>
                            <h3 class="font-bold text-indigo-900 text-sm">AI Tr·ª£ L√Ω Demo (Th√¥ng minh)</h3>
                        </div>
                        <div class="flex gap-2 z-10">
                            <input type="text" id="demo-ai-input" class="flex-1 border border-indigo-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-200 outline-none shadow-sm" placeholder="VD: Li·ªát k√™ sinh vi√™n c√≥ ƒëi·ªÉm tr√™n 8.0..." onkeydown="if(event.key === 'Enter') generateDemoSQL()">
                            <button onclick="generateDemoSQL()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 whitespace-nowrap shadow-md flex items-center gap-1 transition-transform active:scale-95">
                                <span class="material-symbols-outlined text-sm">psychology</span> T·∫°o Code
                            </button>
                        </div>
                        <!-- Result Area -->
                        <div id="demo-ai-result-container" class="hidden mt-1 z-10 animate-fade-in">
                            <div class="bg-slate-800 text-green-300 rounded-lg p-3 text-xs font-mono mb-2 relative border border-slate-700 shadow-inner">
                                <div id="demo-ai-output" class="whitespace-pre-wrap"></div>
                            </div>
                            <button onclick="runGeneratedSQL()" class="w-full bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 flex items-center justify-center gap-2 shadow-md transition-transform active:scale-95">
                                <span class="material-symbols-outlined text-base">rocket_launch</span> Ch·∫°y Query Ngay
                            </button>
                        </div>
                    </div>

                    <!-- Editor -->
                    <div class="flex-1 bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden relative group">
                        <div class="bg-slate-800 text-slate-300 px-4 py-2 text-xs flex justify-between items-center">
                            <span class="font-mono">SQL Query Editor</span>
                            <div class="flex gap-2">
                                <button onclick="insertSampleQuery(`SELECT SV.HoTen, L.TenLop, MH.TenMH, KQ.Diem \nFROM SinhVien SV \nJOIN Lop L ON SV.MaLop = L.MaLop \nJOIN KetQua KQ ON SV.MaSV = KQ.MaSV \nJOIN MonHoc MH ON KQ.MaMH = MH.MaMH \nWHERE KQ.Diem >= 8.0`)" class="hover:text-white transition" title="M·∫´u JOIN">JOIN</button>
                                <button onclick="insertSampleQuery(`SELECT SV.MaLop, COUNT(SV.MaSV) as SoLuongSV \nFROM SinhVien SV \nGROUP BY SV.MaLop`)" class="hover:text-white transition" title="M·∫´u Group By">GROUP BY</button>
                            </div>
                        </div>
                        <textarea id="sql-editor" class="flex-1 w-full p-4 bg-[#1e1e1e] text-indigo-100 font-mono text-sm outline-none resize-none leading-relaxed" spellcheck="false">SELECT * FROM SinhVien WHERE GioiTinh = 'Nu'</textarea>
                        <button onclick="runDemoQuery()" class="absolute bottom-4 right-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition transform active:scale-95 z-10">
                            <span class="material-symbols-outlined text-lg">play_arrow</span> Run Query
                        </button>
                    </div>

                    <!-- Result -->
                    <div class="h-64 bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden">
                        <div class="bg-slate-50 border-b border-slate-200 px-4 py-2 text-xs font-bold text-slate-600 flex justify-between">
                            <span>K·∫øt qu·∫£ truy v·∫•n</span>
                            <span id="row-count" class="text-indigo-600">0 d√≤ng</span>
                        </div>
                        <div class="overflow-auto flex-1 p-0 custom-scroll relative" id="query-result-container">
                            <div class="flex flex-col items-center justify-center h-full text-slate-400 text-sm italic">
                                <span class="material-symbols-outlined text-4xl mb-2 opacity-50">table_chart</span>
                                Nh·∫•n "Run Query" ƒë·ªÉ xem k·∫øt qu·∫£
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1.1 DDL SECTION (Original) -->
        <section id="ddl" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">table_view</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">1.1 ƒê·ªãnh nghƒ©a D·ªØ li·ªáu (DDL)</h2>
                    <p class="text-slate-500 text-sm">C√∫ ph√°p t·∫°o b·∫£ng, thi·∫øt l·∫≠p r√†ng bu·ªôc to√†n v·∫πn v√† ch·ªânh s·ª≠a c·∫•u tr√∫c.</p>
                </div>
            </div>

            <!-- Sub-Tabs -->
            <div class="bg-slate-200/50 p-1 rounded-lg inline-flex mb-6 no-print tab-buttons-container">
                <button onclick="switchSubTab('ddl', 'create')" class="tab-btn-ddl active px-4 py-2 rounded text-sm font-medium text-slate-600 transition" data-target="create">1. T·∫°o B·∫£ng</button>
                <button onclick="switchSubTab('ddl', 'constraints')" class="tab-btn-ddl px-4 py-2 rounded text-sm font-medium text-slate-600 transition" data-target="constraints">2. C√°c R√†ng Bu·ªôc</button>
                <button onclick="switchSubTab('ddl', 'alter')" class="tab-btn-ddl px-4 py-2 rounded text-sm font-medium text-slate-600 transition" data-target="alter">3. Th√™m/X√≥a C·ªôt</button>
            </div>

            <!-- 1.1.1 Create Table -->
            <div id="ddl-create" class="ddl-content block">
                <div class="grid lg:grid-cols-2 gap-8 items-start">
                    <!-- Explain -->
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 text-sm mb-2">üí° Gi·∫£i th√≠ch chi ti·∫øt</h4>
                            <p class="text-sm text-blue-800 mb-2">ƒê·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu, ta c·∫ßn t·∫°o c√°c "ngƒÉn ch·ª©a" g·ªçi l√† B·∫£ng (Table). V√≠ d·ª• d∆∞·ªõi ƒë√¢y t·∫°o 2 b·∫£ng c√≥ m·ªëi quan h·ªá:</p>
                            <ul class="list-disc list-inside text-sm text-blue-700 space-y-1 ml-1">
                                <li><b>B·∫£ng Lop:</b> Danh m·ª•c l·ªõp h·ªçc. <code>MaLop</code> l√† ƒë·ªãnh danh duy nh·∫•t.</li>
                                <li><b>B·∫£ng SinhVien:</b> Ch·ª©a th√¥ng tin SV. M·ªói SV ph·∫£i thu·ªôc v·ªÅ 1 L·ªõp n√†o ƒë√≥ (li√™n k·∫øt qua <code>MaLop</code>).</li>
                            </ul>
                        </div>
                        <!-- Visual -->
                        <div class="flex items-center justify-center gap-6 p-4 bg-white rounded-lg border border-slate-200">
                            <div class="table-visual">
                                <div class="table-header bg-slate-100">Lop</div>
                                <div class="table-row font-bold"><span class="pk-badge">PK</span> MaLop</div>
                                <div class="table-row">TenLop</div>
                            </div>
                            <div class="h-[2px] w-8 bg-slate-300 relative">
                                <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-[10px] text-slate-500 font-bold">1-N</div>
                            </div>
                            <div class="table-visual">
                                <div class="table-header bg-slate-100">SinhVien</div>
                                <div class="table-row font-bold"><span class="pk-badge">PK</span> MaSV</div>
                                <div class="table-row">HoTen</div>
                                <div class="table-row text-indigo-600 bg-indigo-50 font-medium text-[10px]">FK: MaLop</div>
                            </div>
                        </div>
                    </div>

                    <!-- Code -->
                    <div class="space-y-4">
                        <div class="code-block p-4 rounded-lg overflow-x-auto shadow-sm" id="code-create-table">
<span class="sql-kw">CREATE TABLE</span> Lop (
    MaLop <span class="sql-kw">CHAR</span>(5) <span class="sql-kw">PRIMARY KEY</span>,  <span class="sql-com">-- Kh√≥a ch√≠nh: Kh√¥ng tr√πng, kh√¥ng NULL</span>
    TenLop <span class="sql-kw">NVARCHAR</span>(50) <span class="sql-kw">NOT NULL</span> <span class="sql-com">-- Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng t√™n l·ªõp</span>
);

<span class="sql-kw">CREATE TABLE</span> SinhVien (
    MaSV <span class="sql-kw">CHAR</span>(10) <span class="sql-kw">PRIMARY KEY</span>,
    HoTen <span class="sql-kw">NVARCHAR</span>(100),
    <span class="sql-com">-- MaLop ·ªü ƒë√¢y l√† Kh√≥a Ngo·∫°i tham chi·∫øu sang b·∫£ng Lop</span>
    MaLop <span class="sql-kw">CHAR</span>(5) <span class="sql-kw">REFERENCES</span> Lop(MaLop)
);
                        </div>
                        <button onclick="explainCode('code-create-table', 'expl-create', 'Gi·∫£i th√≠ch k·ªπ v·ªÅ ki·ªÉu d·ªØ li·ªáu CHAR vs NVARCHAR v√† t√°c d·ª•ng c·ªßa REFERENCES.')" class="ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print w-fit flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Ph√¢n t√≠ch Code n√†y
                        </button>
                        <div id="expl-create" class="ai-explanation-box"></div>
                    </div>
                </div>
            </div>

            <!-- 1.1.2 Constraints -->
            <div id="ddl-constraints" class="ddl-content hidden">
                <p class="text-sm text-slate-600 mb-4 bg-white p-3 rounded border border-slate-200">
                    <b>R√†ng bu·ªôc to√†n v·∫πn (Constraints)</b> l√† c√°c quy t·∫Øc √°p ƒë·∫∑t l√™n c·ªôt d·ªØ li·ªáu ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c v√† nh·∫•t qu√°n. D∆∞·ªõi ƒë√¢y l√† 5 lo·∫°i quan tr·ªçng nh·∫•t:
                </p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">PK - Primary Key</span>
                            </div>
                            <p class="text-xs text-slate-600">ƒê·ªãnh danh duy nh·∫•t cho m·ªói d√≤ng (v√≠ d·ª•: S·ªë CMND). M·ªôt b·∫£ng ch·ªâ c√≥ 1 PK.</p>
                        </div>
                        <div class="p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded">FK - Foreign Key</span>
                            </div>
                            <p class="text-xs text-slate-600">ƒê·∫£m b·∫£o d·ªØ li·ªáu tham chi·∫øu t·ªìn t·∫°i (v√≠ d·ª•: Kh√¥ng th·ªÉ nh·∫≠p ƒëi·ªÉm cho 1 SV kh√¥ng t·ªìn t·∫°i).</p>
                        </div>
                        <div class="p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-green-100 text-green-800 px-2 py-0.5 rounded">CHECK</span>
                            </div>
                            <p class="text-xs text-slate-600">Ki·ªÉm tra ƒëi·ªÅu ki·ªán logic. V√≠ d·ª•: <code>Tuoi >= 18</code>, <code>Diem BETWEEN 0 AND 10</code>.</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-purple-100 text-purple-800 px-2 py-0.5 rounded">UNIQUE</span>
                            </div>
                            <p class="text-xs text-slate-600">Gi√° tr·ªã kh√¥ng ƒë∆∞·ª£c tr√πng nhau gi·ªØa c√°c d√≤ng (nh∆∞ng cho ph√©p NULL). V√≠ d·ª•: Email c√° nh√¢n.</p>
                        </div>
                        <div class="p-3 bg-white rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-gray-100 text-slate-800 px-2 py-0.5 rounded">DEFAULT</span>
                            </div>
                            <p class="text-xs text-slate-600">T·ª± ƒëi·ªÅn gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu ng∆∞·ªùi d√πng b·ªè tr·ªëng. V√≠ d·ª•: Ng√†y t·∫°o = H√¥m nay.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-sm font-bold text-slate-700 mb-2">V√≠ d·ª• t·ªïng h·ª£p:</h4>
                    <div class="code-block p-4 rounded-lg shadow-sm" id="code-constraints">
<span class="sql-kw">CREATE TABLE</span> NhanVien (
    MaNV <span class="sql-kw">INT PRIMARY KEY</span>,               
    TenNV <span class="sql-kw">NVARCHAR</span>(50) <span class="sql-kw">NOT NULL</span>,    <span class="sql-com">-- B·∫Øt bu·ªôc nh·∫≠p</span>
    Email <span class="sql-kw">VARCHAR</span>(100) <span class="sql-kw">UNIQUE</span>,      <span class="sql-com">-- Kh√¥ng tr√πng email</span>
    NgayVaoLam <span class="sql-kw">DATE DEFAULT</span> <span class="sql-fn">GETDATE</span>(), <span class="sql-com">-- M·∫∑c ƒë·ªãnh l√† h√¥m nay</span>
    Tuoi <span class="sql-kw">INT CHECK</span> (Tuoi >= 18),      <span class="sql-com">-- Ph·∫£i ƒë·ªß 18 tu·ªïi</span>
    MaPhong <span class="sql-kw">INT REFERENCES</span> Phong(Ma)  <span class="sql-com">-- Ph·∫£i thu·ªôc ph√≤ng ban c√≥ th·∫≠t</span>
);
                    </div>
                    <button onclick="explainCode('code-constraints', 'expl-constraints', 'Gi·∫£i th√≠ch chi ti·∫øt t√°c d·ª•ng c·ªßa t·ª´ng d√≤ng code trong b·∫£ng NhanVien.')" class="mt-3 ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                        <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch v√≠ d·ª• n√†y
                    </button>
                    <div id="expl-constraints" class="ai-explanation-box"></div>
                </div>
            </div>

            <!-- 1.1.3 Alter -->
            <div id="ddl-alter" class="ddl-content hidden">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <p class="text-sm text-yellow-800"><b>L∆∞u √Ω:</b> Vi·ªác s·ª≠a ƒë·ªïi c·∫•u tr√∫c b·∫£ng (ALTER) th∆∞·ªùng √≠t d√πng khi thi·∫øt k·∫ø ban ƒë·∫ßu, nh∆∞ng r·∫•t quan tr·ªçng khi b·∫£o tr√¨ h·ªá th·ªëng th·ª±c t·∫ø (khi y√™u c·∫ßu nghi·ªáp v·ª• thay ƒë·ªïi).</p>
                </div>
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Visual -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center justify-center gap-4 shadow-sm">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wide">Minh h·ªça Th√™m C·ªôt</div>
                        <div class="flex items-center gap-4">
                            <div class="table-visual h-20 w-24 opacity-60 flex flex-col justify-center items-center bg-slate-50 border-dashed border-2">
                                <span class="text-[10px]">C·ªôt A</span>
                                <span class="text-[10px]">C·ªôt B</span>
                            </div>
                            <span class="material-symbols-outlined text-green-600">add_circle</span>
                            <div class="table-visual h-24 w-24 border-green-400 flex flex-col">
                                <div class="flex-1 flex flex-col justify-center items-center">
                                    <span class="text-[10px]">C·ªôt A</span>
                                    <span class="text-[10px]">C·ªôt B</span>
                                </div>
                                <div class="bg-green-100 text-green-800 text-[9px] font-bold py-1 text-center">+ Email</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h4 class="text-sm font-bold text-slate-700 mb-2">1. Th√™m c·ªôt m·ªõi (ADD)</h4>
                            <div class="code-block p-3 rounded text-sm" id="code-add-col"><span class="sql-kw">ALTER TABLE</span> SinhVien <span class="sql-kw">ADD</span> Email <span class="sql-kw">VARCHAR</span>(50);</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h4 class="text-sm font-bold text-slate-700 mb-2">2. X√≥a c·ªôt (DROP)</h4>
                            <div class="code-block p-3 rounded text-sm" id="code-drop-col"><span class="sql-kw">ALTER TABLE</span> SinhVien <span class="sql-kw">DROP COLUMN</span> Email;</div>
                        </div>
                        <button onclick="explainCode('code-add-col', 'expl-alter', 'Gi·∫£i th√≠ch khi n√†o c·∫ßn d√πng ALTER TABLE v√† r·ªßi ro khi DROP COLUMN.')" class="ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                            <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch Alter
                        </button>
                        <div id="expl-alter" class="ai-explanation-box"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1.2 DML SECTION -->
        <section id="dml" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">query_stats</span></div>
                <div><h2 class="text-2xl font-bold text-slate-800">1.2 Thao t√°c D·ªØ li·ªáu (DML)</h2></div>
            </div>

            <!-- AI TEXT TO SQL -->
            <div class="bg-white p-6 rounded-xl border border-indigo-100 shadow-lg mb-8 no-print ring-1 ring-indigo-50">
                <div class="flex items-center gap-2 mb-3">
                    <span class="material-symbols-outlined text-indigo-600 text-2xl">auto_awesome</span>
                    <div>
                        <h3 class="font-bold text-indigo-900 text-lg">AI Tr·ª£ L√Ω SQL</h3>
                        <p class="text-xs text-slate-500">Nh·∫≠p y√™u c·∫ßu b·∫±ng ti·∫øng Vi·ªát, AI s·∫Ω vi·∫øt c√¢u l·ªánh SQL cho b·∫°n.</p>
                    </div>
                </div>
                <div class="flex gap-4 flex-col md:flex-row">
                    <div class="flex-1">
                        <textarea id="ai-sql-input" class="w-full p-3 border border-slate-300 rounded-lg text-sm h-28 focus:ring-2 focus:ring-indigo-500 outline-none resize-none font-sans" placeholder="V√≠ d·ª•: T√¨m top 5 sinh vi√™n c√≥ ƒëi·ªÉm trung b√¨nh cao nh·∫•t khoa CNTT..."></textarea>
                        <button onclick="generateSQL()" class="mt-2 bg-indigo-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-md w-full md:w-auto flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">magic_button</span> T·∫°o Code SQL
                        </button>
                    </div>
                    <div class="flex-1">
                        <div id="ai-sql-output" class="w-full p-4 border border-slate-200 bg-slate-50 rounded-lg text-sm font-mono h-28 overflow-auto text-slate-400 italic flex items-center justify-center">
                            K·∫øt qu·∫£ code s·∫Ω hi·ªán ·ªü ƒë√¢y...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-Tabs -->
            <div class="flex flex-wrap gap-2 mb-6 no-print tab-buttons-container">
                <button onclick="switchSubTab('dml', 'update')" class="tab-btn-dml active px-4 py-2 rounded-lg text-sm transition border border-slate-200" data-target="update">1. C·∫≠p nh·∫≠t D·ªØ li·ªáu</button>
                <button onclick="switchSubTab('dml', 'query')" class="tab-btn-dml px-4 py-2 rounded-lg text-sm transition border border-transparent bg-slate-100 text-slate-600 hover:bg-slate-200" data-target="query">2. Truy v·∫•n & T·∫≠p h·ª£p</button>
                <button onclick="switchSubTab('dml', 'group')" class="tab-btn-dml px-4 py-2 rounded-lg text-sm transition border border-transparent bg-slate-100 text-slate-600 hover:bg-slate-200" data-target="group">3. Th·ªëng k√™ & Gom nh√≥m</button>
                <button onclick="switchSubTab('dml', 'div')" class="tab-btn-dml px-4 py-2 rounded-lg text-sm transition border border-transparent bg-slate-100 text-slate-600 hover:bg-slate-200" data-target="div">4. Ph√©p Chia</button>
            </div>

            <!-- 1.2.1 Update -->
            <div id="dml-update" class="dml-content block">
                <div class="space-y-6" id="code-dml-ops">
                    <div class="bg-white p-5 rounded-lg border border-green-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                        <h4 class="text-green-800 font-bold text-sm mb-2 uppercase tracking-wide">1. INSERT (Th√™m m·ªõi)</h4>
                        <p class="text-sm text-slate-600 mb-2">Th√™m d√≤ng d·ªØ li·ªáu m·ªõi. C·∫ßn li·ªát k√™ ƒë√∫ng th·ª© t·ª± c·ªôt ho·∫∑c ch·ªâ ƒë·ªãnh t√™n c·ªôt.</p>
                        <div class="code-block p-3 rounded text-sm">INSERT INTO SinhVien (MaSV, HoTen) VALUES ('SV01', N'Nguy·ªÖn VƒÉn A');</div>
                    </div>
                    <div class="bg-white p-5 rounded-lg border border-blue-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <h4 class="text-blue-800 font-bold text-sm mb-2 uppercase tracking-wide">2. UPDATE (S·ª≠a ƒë·ªïi)</h4>
                        <p class="text-sm text-slate-600 mb-2">C·∫≠p nh·∫≠t gi√° tr·ªã. <b class="text-red-500">L∆∞u √Ω:</b> Lu√¥n nh·ªõ d√πng <code>WHERE</code>, n·∫øu kh√¥ng s·∫Ω s·ª≠a to√†n b·ªô b·∫£ng!</p>
                        <div class="code-block p-3 rounded text-sm">UPDATE SinhVien SET DiemTB = 9.0 WHERE MaSV = 'SV01';</div>
                    </div>
                    <div class="bg-white p-5 rounded-lg border border-red-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                        <h4 class="text-red-800 font-bold text-sm mb-2 uppercase tracking-wide">3. DELETE (X√≥a)</h4>
                        <p class="text-sm text-slate-600 mb-2">X√≥a d√≤ng d·ªØ li·ªáu. C≈©ng c·∫ßn <code>WHERE</code> ƒë·ªÉ tr√°nh x√≥a s·∫°ch b·∫£ng.</p>
                        <div class="code-block p-3 rounded text-sm">DELETE FROM SinhVien WHERE MaLop = 'L01';</div>
                    </div>
                </div>
                <button onclick="explainCode('code-dml-ops', 'expl-dml-ops', 'Gi·∫£i th√≠ch chi ti·∫øt, ƒë·∫∑c bi·ªát l√† r·ªßi ro khi qu√™n WHERE trong UPDATE/DELETE.')" class="mt-6 ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                    <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch Thao t√°c DL
                </button>
                <div id="expl-dml-ops" class="ai-explanation-box"></div>
            </div>

            <!-- 1.2.2 Query -->
            <div id="dml-query" class="dml-content hidden">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Truy v·∫•n tr√™n T·∫≠p h·ª£p (Set Operations)</h3>
                    <div class="flex flex-col md:flex-row gap-8 items-center mb-6">
                        <div class="venn-container">
                            <div class="venn-circle venn-a text-white">A</div>
                            <div class="venn-circle venn-b text-white">B</div>
                        </div>
                        <div class="text-sm space-y-2 flex-1">
                            <p><span class="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">UNION</span>: G·ªôp (A+B). T·ª± ƒë·ªông lo·∫°i b·ªè tr√πng l·∫∑p.</p>
                            <p><span class="font-bold text-purple-600 bg-purple-50 px-1 rounded">INTERSECT</span>: L·∫•y ph·∫ßn chung (Giao nhau) c·ªßa A v√† B.</p>
                            <p><span class="font-bold text-pink-600 bg-pink-50 px-1 rounded">EXCEPT</span>: L·∫•y ph·∫ßn c√≥ trong A nh∆∞ng KH√îNG c√≥ trong B (Ph√©p tr·ª´).</p>
                        </div>
                    </div>
                    <div class="code-block p-4 rounded-lg text-sm" id="code-sets">
<span class="sql-com">-- V√≠ d·ª•: T√¨m c√°c sinh vi√™n h·ªçc To√°n HO·∫∂C h·ªçc L√Ω</span>
<span class="sql-kw">SELECT</span> MaSV <span class="sql-kw">FROM</span> DiemToan
<span class="sql-kw">UNION</span>
<span class="sql-kw">SELECT</span> MaSV <span class="sql-kw">FROM</span> DiemLy;
                    </div>
                    <button onclick="explainCode('code-sets', 'expl-sets', 'Gi·∫£i th√≠ch s·ª± kh√°c nhau gi·ªØa UNION v√† UNION ALL.')" class="mt-4 ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                        <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch T·∫≠p h·ª£p
                    </button>
                    <div id="expl-sets" class="ai-explanation-box"></div>
                </div>
            </div>

            <!-- 1.2.3 Group -->
            <div id="dml-group" class="dml-content hidden">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-2">Th·ªëng k√™ & Gom nh√≥m</h3>
                    <p class="text-sm text-slate-600 mb-4 italic">"Cho t√¥i bi·∫øt m·ªói khoa c√≥ bao nhi√™u sinh vi√™n?" -> D√πng GROUP BY.</p>
                    
                    <div class="bg-slate-50 p-3 rounded mb-4 border border-slate-200">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-1">Th·ª© t·ª± th·ª±c thi Logic:</p>
                        <div class="flex items-center gap-2 text-xs font-mono text-slate-700 overflow-x-auto">
                            <span>1. FROM/JOIN</span>
                            <span>‚Üí</span>
                            <span>2. WHERE (L·ªçc d√≤ng)</span>
                            <span>‚Üí</span>
                            <span class="bg-yellow-200 px-1 rounded">3. GROUP BY (Gom)</span>
                            <span>‚Üí</span>
                            <span class="bg-yellow-200 px-1 rounded">4. HAVING (L·ªçc nh√≥m)</span>
                            <span>‚Üí</span>
                            <span>5. SELECT</span>
                        </div>
                    </div>

                    <div class="code-block p-4 rounded-lg text-sm" id="code-group">
<span class="sql-kw">SELECT</span> Khoa, <span class="sql-fn">COUNT</span>(*) <span class="sql-kw">AS</span> SoLuong
<span class="sql-kw">FROM</span> SinhVien
<span class="sql-kw">GROUP BY</span> Khoa
<span class="sql-kw">HAVING</span> <span class="sql-fn">COUNT</span>(*) > 50; <span class="sql-com">-- Ch·ªâ l·∫•y khoa ƒë√¥ng SV</span>
                    </div>
                    <button onclick="explainCode('code-group', 'expl-group', 'Gi·∫£i th√≠ch t·∫°i sao kh√¥ng d√πng WHERE cho COUNT(*) ƒë∆∞·ª£c m√† ph·∫£i d√πng HAVING.')" class="mt-4 ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                        <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch GROUP BY
                    </button>
                    <div id="expl-group" class="ai-explanation-box"></div>
                </div>
            </div>

            <!-- 1.2.4 Division -->
            <div id="dml-div" class="dml-content hidden">
                <div class="bg-indigo-50 border border-indigo-200 p-5 rounded-lg mb-6">
                    <h3 class="text-indigo-900 font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined">psychology</span> Ph√©p Chia (Relational Division)
                    </h3>
                    <p class="text-sm text-indigo-800 mb-2">B√†i to√°n kinh ƒëi·ªÉn: <b>"T√¨m sinh vi√™n ƒë√£ h·ªçc T·∫§T C·∫¢ c√°c m√¥n h·ªçc".</b></p>
                    <p class="text-xs text-indigo-700 italic">C√°ch t∆∞ duy: T√¨m nh·ªØng SV m√† "Kh√¥ng c√≥ m√¥n h·ªçc n√†o m√† SV ƒë√≥ kh√¥ng h·ªçc" (Ph·ªß ƒë·ªãnh c·ªßa ph·ªß ƒë·ªãnh).</p>
                </div>
                <div class="code-block p-4 rounded-lg text-sm shadow-md" id="code-div">
<span class="sql-kw">SELECT</span> * <span class="sql-kw">FROM</span> SinhVien SV
<span class="sql-kw">WHERE NOT EXISTS</span> (
    <span class="sql-kw">SELECT</span> * <span class="sql-kw">FROM</span> MonHoc MH
    <span class="sql-kw">WHERE NOT EXISTS</span> (
        <span class="sql-kw">SELECT</span> * <span class="sql-kw">FROM</span> KetQua KQ
        <span class="sql-kw">WHERE</span> KQ.MaSV = SV.MaSV 
        <span class="sql-kw">AND</span> KQ.MaMH = MH.MaMH
    )
);
                </div>
                <button onclick="explainCode('code-div', 'expl-div', 'Gi·∫£i th√≠ch logic 2 l·∫ßn NOT EXISTS m·ªôt c√°ch d·ªÖ hi·ªÉu nh·∫•t.')" class="mt-4 ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                    <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch Logic
                </button>
                <div id="expl-div" class="ai-explanation-box"></div>
            </div>
        </section>

        <!-- 1.3 TRIGGER -->
        <section id="triggers" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">bolt</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">1.3 Trigger</h2>
                    <p class="text-slate-500 text-sm">C∆° ch·∫ø t·ª± ƒë·ªông h√≥a: T·ª± ch·∫°y khi d·ªØ li·ªáu thay ƒë·ªïi.</p>
                </div>
            </div>
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Concept -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center justify-center gap-4">
                    <h3 class="font-bold text-slate-700 w-full text-center text-sm border-b pb-2 mb-2">Quy tr√¨nh x·ª≠ l√Ω</h3>
                    <div class="flow-node border-blue-300 bg-blue-50 text-blue-800 w-full">User INSERT/UPDATE</div>
                    <div class="material-symbols-outlined text-slate-300">arrow_downward</div>
                    <div class="flow-node border-yellow-300 bg-yellow-50 text-yellow-800 border-dashed w-full relative">
                        Trigger K√≠ch Ho·∫°t
                        <div class="text-[10px] font-normal text-slate-500 mt-1">D·ªØ li·ªáu n·∫±m trong b·∫£ng ·∫£o <code>inserted</code> / <code>deleted</code></div>
                    </div>
                    <div class="material-symbols-outlined text-slate-300">arrow_downward</div>
                    <div class="flex gap-2 w-full">
                         <div class="flow-node border-green-300 bg-green-50 text-green-800 flex-1">Cho ph√©p</div>
                         <div class="flow-node border-red-300 bg-red-50 text-red-800 flex-1">Rollback</div>
                    </div>
                </div>
                <!-- Code -->
                <div class="lg:col-span-2 space-y-4">
                      <div class="code-block p-4 rounded-lg text-sm overflow-auto" id="code-trig">
<span class="sql-kw">CREATE TRIGGER</span> trg_CheckDiem <span class="sql-kw">ON</span> KetQua
<span class="sql-kw">FOR INSERT, UPDATE</span>
<span class="sql-kw">AS</span>
<span class="sql-kw">BEGIN</span>
  <span class="sql-com">-- Ki·ªÉm tra trong b·∫£ng ·∫£o inserted (d·ªØ li·ªáu m·ªõi nh·∫≠p)</span>
  <span class="sql-kw">IF EXISTS</span> (<span class="sql-kw">SELECT</span> * <span class="sql-kw">FROM</span> inserted <span class="sql-kw">WHERE</span> Diem < 0)
  <span class="sql-kw">BEGIN</span>
    <span class="sql-kw">PRINT</span> N'L·ªói: ƒêi·ªÉm kh√¥ng th·ªÉ √¢m!';
    <span class="sql-kw">ROLLBACK TRANSACTION</span>; <span class="sql-com">-- H·ªßy b·ªè thao t√°c</span>
  <span class="sql-kw">END</span>
<span class="sql-kw">END</span>
                      </div>
                      <button onclick="explainCode('code-trig', 'expl-trig', 'Gi·∫£i th√≠ch b·∫£ng inserted l√† g√¨ v√† t·∫°i sao ph·∫£i d√πng Rollback.')" class="ai-btn text-xs bg-indigo-600 text-white px-4 py-2 rounded shadow-sm hover:bg-indigo-700 transition no-print flex items-center gap-2 w-fit">
                        <span class="material-symbols-outlined text-sm">smart_toy</span> AI: Gi·∫£i th√≠ch Trigger
                    </button>
                    <div id="expl-trig" class="ai-explanation-box"></div>
                </div>
            </div>
        </section>

        <!-- 2.1 KEYS -->
        <section id="keys" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">key</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">2.1 T√¨m Kho√° (Bao ƒê√≥ng)</h2>
                    <p class="text-slate-500 text-sm">S·ª≠ d·ª•ng thu·∫≠t to√°n bao ƒë√≥ng (Closure) ƒë·ªÉ t√¨m kh√≥a ch√≠nh.</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <!-- Concept -->
                <div class="mb-4">
                    <p class="concept-note"><b>Kh√°i ni·ªám:</b> Bao ƒë√≥ng c·ªßa t·∫≠p thu·ªôc t√≠nh X (k√Ω hi·ªáu X+) l√† t·∫≠p h·ª£p t·∫•t c·∫£ c√°c thu·ªôc t√≠nh c√≥ th·ªÉ suy ra ƒë∆∞·ª£c t·ª´ X d·ª±a tr√™n c√°c ph·ª• thu·ªôc h√†m (F).</p>
                    <p class="concept-note"><b>·ª®ng d·ª•ng:</b> N·∫øu X+ ch·ª©a t·∫•t c·∫£ thu·ªôc t√≠nh c·ªßa b·∫£ng -> X l√† m·ªôt Si√™u kh√≥a.</p>
                </div>
                
                <!-- Input Tool (Hidden on Print) -->
                <div class="grid md:grid-cols-2 gap-6 bg-slate-50 p-4 rounded-lg border border-slate-200 no-print">
                    <div class="space-y-3">
                        <input type="text" id="closure-input" value="A, B" class="w-full p-2 border rounded text-sm font-mono" placeholder="VD: A, B">
                        <textarea id="fds-input" rows="4" class="w-full p-2 border rounded text-sm font-mono" placeholder="A -> C">A -> C
B -> D
C, D -> E</textarea>
                        <button onclick="calculateClosure()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold">T√≠nh X+</button>
                    </div>
                    <div class="bg-white p-4 rounded border border-slate-200" id="closure-result">...</div>
                </div>

                <!-- Static Example (Visible ONLY on Print) -->
                <div class="hidden print:block mt-4 p-4 border border-slate-200 rounded bg-slate-50">
                    <h4 class="font-bold text-sm text-slate-700 mb-2">V√≠ d·ª• minh h·ªça thu·∫≠t to√°n Bao ƒë√≥ng:</h4>
                    <div class="text-sm font-mono text-slate-600">
                        <p>Cho R(A, B, C, D), F = { A -> B, B -> C }</p>
                        <p class="mt-1">T√¨m bao ƒë√≥ng {A}+:</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>B∆∞·ªõc 1: X = {A}</li>
                            <li>B∆∞·ªõc 2: C√≥ A -> B, th√™m B => X = {A, B}</li>
                            <li>B∆∞·ªõc 3: C√≥ B -> C, th√™m C => X = {A, B, C}</li>
                        </ul>
                        <p class="mt-2 font-bold text-indigo-700">=> K·∫øt qu·∫£: {A}+ = {A, B, C}</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2.2 NORMALIZATION -->
        <section id="normalization" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">checklist</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">2.2 C√°c D·∫°ng Chu·∫©n (Normal Forms)</h2>
                    <p class="text-slate-500 text-sm">Lo·∫°i b·ªè d∆∞ th·ª´a d·ªØ li·ªáu ƒë·ªÉ tr√°nh d·ªã th∆∞·ªùng (Anomalies).</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="absolute right-0 top-0 text-6xl text-slate-100 font-bold -z-10 group-hover:text-indigo-50 transition">1</div>
                    <h3 class="font-bold text-lg text-indigo-700">1NF (Nguy√™n t·ªë)</h3>
                    <p class="text-xs text-slate-600 mt-2 leading-relaxed">Gi√° tr·ªã t·∫°i m·ªói √¥ ph·∫£i l√† ƒë∆°n nguy√™n (Atomic), kh√¥ng ch·ª©a danh s√°ch (v√≠ d·ª•: "09123, 09456" l√† sai).</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="absolute right-0 top-0 text-6xl text-slate-100 font-bold -z-10 group-hover:text-purple-50 transition">2</div>
                    <h3 class="font-bold text-lg text-purple-700">2NF (Ph·ª• thu·ªôc ƒë·∫ßy ƒë·ªß)</h3>
                    <p class="text-xs text-slate-600 mt-2 leading-relaxed">ƒê√£ ƒë·∫°t 1NF. C√°c thu·ªôc t√≠nh kh√¥ng kh√≥a ph·∫£i ph·ª• thu·ªôc v√†o <b>to√†n b·ªô</b> kh√≥a ch√≠nh, kh√¥ng ph·ª• thu·ªôc v√†o m·ªôt ph·∫ßn c·ªßa kh√≥a.</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="absolute right-0 top-0 text-6xl text-slate-100 font-bold -z-10 group-hover:text-pink-50 transition">3</div>
                    <h3 class="font-bold text-lg text-pink-700">3NF (Kh√¥ng b·∫Øc c·∫ßu)</h3>
                    <p class="text-xs text-slate-600 mt-2 leading-relaxed">ƒê√£ ƒë·∫°t 2NF. Kh√¥ng c√≥ ph·ª• thu·ªôc b·∫Øc c·∫ßu (A -> B -> C). Thu·ªôc t√≠nh kh√¥ng kh√≥a ch·ªâ ƒë∆∞·ª£c ph·ª• thu·ªôc tr·ª±c ti·∫øp v√†o kh√≥a ch√≠nh.</p>
                </div>
            </div>

            <!-- AI Check -->
            <div class="bg-white p-6 rounded-xl border border-indigo-100 shadow-sm no-print">
                 <div class="flex items-center gap-2 mb-3">
                     <span class="material-symbols-outlined text-indigo-600">auto_fix_high</span>
                     <div>
                         <h3 class="font-bold text-indigo-900 text-sm">AI Ki·ªÉm tra D·∫°ng Chu·∫©n</h3>
                         <p class="text-[11px] text-slate-500">Nh·∫≠p l∆∞·ª£c ƒë·ªì v√† ph·ª• thu·ªôc h√†m, AI s·∫Ω x√°c ƒë·ªãnh n√≥ ƒëang ·ªü d·∫°ng chu·∫©n n√†o.</p>
                     </div>
                 </div>
                 <div class="flex gap-2 flex-col md:flex-row">
                     <input type="text" id="nf-input" class="flex-1 p-3 border border-slate-300 rounded-lg text-sm font-mono" placeholder="R(A,B,C,D), Key: A, F={A->B, B->C}">
                     <button onclick="checkNormalForm()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 text-sm shadow-md whitespace-nowrap flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">check</span> Ki·ªÉm tra
                     </button>
                 </div>
                 <div id="nf-result" class="mt-4 hidden p-4 bg-white border border-slate-200 rounded-lg text-sm text-slate-700 leading-relaxed shadow-inner font-mono"></div>
             </div>
        </section>
        
        <!-- 2.3 DECOMPOSITION -->
        <section id="decomposition" class="content-section max-w-5xl mx-auto mb-16 animate-fade-in hidden">
             <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-4">
                <div class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><span class="material-symbols-outlined">call_split</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">2.3 Ph√¢n R√£ (Decomposition)</h2>
                    <p class="text-slate-500 text-sm">K·ªπ thu·∫≠t t√°ch b·∫£ng ƒë·ªÉ ƒë·∫°t chu·∫©n cao h∆°n (3NF/BCNF) m√† kh√¥ng l√†m m·∫•t d·ªØ li·ªáu.</p>
                </div>
            </div>
            
            <!-- Theory Clarification -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                <h4 class="font-bold text-yellow-900 text-sm mb-2">Nguy√™n t·∫Øc v√†ng: Lossless Join (B·∫£o to√†n th√¥ng tin)</h4>
                <p class="text-xs text-yellow-800 leading-relaxed mb-2">
                    Khi t√°ch 1 b·∫£ng R th√†nh R1 v√† R2, ph√©p n·ªëi t·ª± nhi√™n (NATURAL JOIN) c·ªßa R1 v√† R2 ph·∫£i tr·∫£ v·ªÅ ch√≠nh x√°c b·∫£ng R ban ƒë·∫ßu (kh√¥ng th·ª´a, kh√¥ng thi·∫øu d√≤ng).
                </p>
                <div class="text-xs font-mono bg-white/50 p-2 rounded border border-yellow-200 text-yellow-900">
                    ƒêi·ªÅu ki·ªán: (R1 ‚à© R2) ‚Üí R1  HO·∫∂C  (R1 ‚à© R2) ‚Üí R2
                    <br>
                    (Ph·∫ßn giao chung ph·∫£i l√† Kh√≥a c·ªßa √≠t nh·∫•t 1 b·∫£ng con)
                </div>
            </div>

            <!-- Visual Diagram -->
            <div class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col md:flex-row items-center justify-center gap-8">
                <div class="border border-red-300 bg-red-50 p-3 rounded w-32 text-center shadow-sm">
                    <div class="text-xs font-bold text-red-800">R(A,B,C)</div>
                    <div class="text-[10px] text-red-600 mt-1">D∆∞ th·ª´a d·ªØ li·ªáu</div>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[10px] text-slate-400 mb-1">Decompose</span>
                    <span class="material-symbols-outlined text-slate-400 text-2xl">arrow_right_alt</span>
                </div>
                <div class="flex gap-4">
                    <div class="border border-green-300 bg-green-50 p-3 rounded w-28 text-center shadow-sm relative">
                        <div class="text-xs font-bold text-green-800">R1(A,B)</div>
                        <div class="absolute -right-2 top-1/2 w-4 h-[2px] bg-green-600 z-10"></div>
                    </div>
                    <div class="border border-green-300 bg-green-50 p-3 rounded w-28 text-center shadow-sm">
                        <div class="text-xs font-bold text-green-800">R2(B,C)</div>
                        <div class="text-[9px] text-green-700 mt-1 font-semibold">B l√† FK</div>
                    </div>
                </div>
            </div>

            <!-- AI Suggestion -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm no-print">
                <div class="flex items-center gap-2 mb-3">
                    <span class="material-symbols-outlined text-purple-600">lightbulb</span>
                    <div>
                        <h3 class="font-bold text-purple-900 text-sm">AI G·ª£i √Ω Ph√¢n r√£</h3>
                        <p class="text-[11px] text-slate-500">G·∫∑p b·∫£ng ch∆∞a chu·∫©n? Nh·∫≠p v√†o ƒë√¢y ƒë·ªÉ AI g·ª£i √Ω c√°ch t√°ch b·∫£ng.</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-col md:flex-row">
                    <input type="text" id="decomp-input" class="flex-1 p-3 border border-slate-300 rounded-lg text-sm font-mono" placeholder="R(A,B,C,D,E), F={A->B, B->C...}">
                    <button onclick="suggestDecomp()" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 text-sm shadow-md whitespace-nowrap flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">analytics</span> Ph√¢n t√≠ch
                    </button>
                </div>
                <div id="decomp-result" class="mt-4 hidden p-4 bg-purple-50 border border-purple-100 rounded-lg text-sm text-slate-700 leading-relaxed shadow-inner font-mono"></div>
            </div>
        </section>

    </main>

    <!-- FLOATING CHAT -->
    <button id="ai-fab" onclick="toggleChat()" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 rounded-full shadow-lg text-white flex items-center justify-center hover:bg-indigo-700 transition ai-float z-50 no-print">
        <span class="material-symbols-outlined text-2xl">chat</span>
    </button>
    
    <div id="chat-modal" class="fixed bottom-24 right-6 w-96 bg-white rounded-xl shadow-2xl border border-indigo-100 hidden flex-col z-50 h-[500px] no-print overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white flex justify-between items-center rounded-t-xl">
            <h3 class="font-bold flex items-center gap-2 text-sm"><span class="material-symbols-outlined text-sm">smart_toy</span> Tr·ª£ L√Ω SQL</h3>
            <button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded transition"><span class="material-symbols-outlined text-sm">close</span></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 text-sm"></div>
        <form onsubmit="handleChat(event)" class="p-3 bg-white border-t border-slate-100 flex gap-2">
            <input id="chat-input" type="text" class="flex-1 border rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500" placeholder="H·ªèi g√¨ ƒë√≥...">
            <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition shadow-sm"><span class="material-symbols-outlined text-sm">send</span></button>
        </form>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-2 text-slate-800">C√†i ƒë·∫∑t Gemini API</h3>
            <p class="text-sm text-slate-500 mb-4">Nh·∫≠p Key ƒë·ªÉ k√≠ch ho·∫°t c√°c t√≠nh nƒÉng AI.</p>
            <input type="password" id="api-key-input" class="w-full border p-3 rounded-lg mb-4 text-sm font-mono outline-none focus:ring-2 focus:ring-indigo-500" placeholder="AIza...">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded text-sm font-medium">ƒê√≥ng</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold text-sm shadow-sm">L∆∞u Key</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-slate-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-[-150%] transition-transform duration-300 z-50 flex items-center gap-2 no-print text-sm">
        <span class="material-symbols-outlined text-green-400 text-lg">check_circle</span>
        <span id="toast-msg">Th√¥ng b√°o</span>
    </div>

    <!-- Logic Script -->
    <script>
        // --- UI ---
        function scrollToSection(id) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('block');
            
            // Highlight sidebar
            document.querySelectorAll('#sidebar .nav-item').forEach(btn => {
               btn.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-r-4', 'border-indigo-600', 'font-bold');
               btn.classList.add('text-slate-600');
               if(btn.onclick.toString().includes(id)) {
                   btn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-r-4', 'border-indigo-600', 'font-bold');
                   btn.classList.remove('text-slate-600');
               }
            });

            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
        }

        function switchSubTab(parentId, targetId) {
            document.querySelectorAll(`#${parentId} .${parentId}-content`).forEach(el => el.classList.add('hidden'));
            document.getElementById(`${parentId}-${targetId}`).classList.remove('hidden');
            document.querySelectorAll(`.tab-btn-${parentId}`).forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-indigo-700', 'shadow-sm', 'border', 'border-slate-200');
                btn.classList.add('text-slate-600', 'bg-transparent');
                if(btn.dataset.target === targetId) btn.classList.add('active', 'bg-white', 'text-indigo-700', 'shadow-sm', 'border', 'border-slate-200');
            });
        }

        function toggleChat() { document.getElementById('chat-modal').classList.toggle('hidden'); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        
        function saveApiKey() {
            localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value.trim());
            document.getElementById('settings-modal').classList.add('hidden');
            showToast("ƒê√£ l∆∞u API Key!");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-[-150%]');
            setTimeout(()=>t.classList.add('translate-y-[-150%]'), 2000);
        }

        // --- Logic: Closure ---
        function calculateClosure() {
            const attrs = document.getElementById('closure-input').value.split(',').map(s=>s.trim()).filter(s=>s);
            const fds = document.getElementById('fds-input').value.split('\n').map(l=>{
                const p=l.split('->'); return p.length===2?{lhs:p[0].split(','), rhs:p[1].split(',')}:null;
            }).filter(x=>x);
            let closure = new Set(attrs);
            let changed=true;
            let steps = [];
            while(changed){
                changed=false;
                fds.forEach(fd=>{
                    if(fd.lhs.every(a=>closure.has(a.trim()))){
                        fd.rhs.forEach(b=>{ 
                            if(!closure.has(b.trim())){ 
                                closure.add(b.trim()); 
                                steps.push(`D√πng ${fd.lhs}->${fd.rhs}: Th√™m ${b.trim()}`);
                                changed=true; 
                            } 
                        });
                    }
                });
            }
            const resHtml = steps.length ? steps.map(s=>`<div>- ${s}</div>`).join('') : '<div>Kh√¥ng t√¨m th·∫•y thu·ªôc t√≠nh m·ªõi.</div>';
            document.getElementById('closure-result').innerHTML = resHtml + `<div class='mt-2 pt-2 border-t font-bold text-indigo-700'>K·∫øt qu·∫£: { ${Array.from(closure).join(', ')} }</div>`;
        }

        // --- AI ---
        async function callGemini(prompt, sys) {
            const key = localStorage.getItem('gemini_api_key');
            if(!key) { openSettings(); return "Vui l√≤ng nh·∫≠p API Key."; }
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: sys }] } })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "L·ªói ph·∫£n h·ªìi t·ª´ AI.";
            } catch(e) { return "L·ªói: " + e.message; }
        }

        async function handleChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-messages');
            if(!input.value.trim()) return;
            msgs.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-indigo-600 text-white p-2 rounded-lg text-sm max-w-[85%]">${input.value}</div></div>`;
            msgs.scrollTop = msgs.scrollHeight;
            const reply = await callGemini(input.value, "B·∫°n l√† gi·∫£ng vi√™n SQL th√¢n thi·ªán, gi·∫£i th√≠ch ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu.");
            msgs.innerHTML += `<div class="flex mb-2"><div class="bg-gray-100 p-2 rounded-lg text-sm text-slate-800 border border-slate-200 max-w-[90%]">${marked.parse(reply)}</div></div>`;
            msgs.scrollTop = msgs.scrollHeight;
            input.value = '';
        }

        async function explainCode(codeId, outId, ctx) {
            const out = document.getElementById(outId);
            out.style.display='block'; out.innerHTML = '<span class="loading-dots">ƒêang ph√¢n t√≠ch</span>';
            const code = document.getElementById(codeId).innerText;
            const res = await callGemini(`Code SQL: \n\`\`\`sql\n${code}\n\`\`\`\n\nY√™u c·∫ßu: ${ctx}`, "Gi·∫£i th√≠ch s∆∞ ph·∫°m, r√µ r√†ng, t·∫≠p trung v√†o b·∫£n ch·∫•t.");
            out.innerHTML = marked.parse(res);
        }

        async function generateSQL() {
            const out = document.getElementById('ai-sql-output');
            out.innerHTML = '<span class="loading-dots">ƒêang vi·∫øt code</span>';
            const req = document.getElementById('ai-sql-input').value;
            const res = await callGemini(`Vi·∫øt code MS SQL Server cho y√™u c·∫ßu: "${req}". Ch·ªâ tr·∫£ v·ªÅ block code SQL, kh√¥ng gi·∫£i th√≠ch g√¨ th√™m.`, "SQL Expert");
            out.innerHTML = marked.parse(res);
        }

        async function checkNormalForm() {
            const out = document.getElementById('nf-result');
            out.classList.remove('hidden'); out.innerHTML = '<span class="loading-dots">ƒêang ki·ªÉm tra</span>';
            const req = document.getElementById('nf-input').value;
            const res = await callGemini(`Ki·ªÉm tra d·∫°ng chu·∫©n cao nh·∫•t (1NF, 2NF, 3NF hay BCNF) cho l∆∞·ª£c ƒë·ªì n√†y: "${req}". Gi·∫£i th√≠ch t·∫°i sao n√≥ ƒë·∫°t/kh√¥ng ƒë·∫°t t·ª´ng chu·∫©n.`, "DBA Expert");
            out.innerHTML = marked.parse(res);
        }

        async function suggestDecomp() {
            const out = document.getElementById('decomp-result');
            out.classList.remove('hidden'); out.innerHTML = '<span class="loading-dots">ƒêang ph√¢n t√≠ch</span>';
            const req = document.getElementById('decomp-input').value;
            const res = await callGemini(`G·ª£i √Ω ph√¢n r√£ l∆∞·ª£c ƒë·ªì n√†y v·ªÅ 3NF/BCNF sao cho b·∫£o to√†n th√¥ng tin: "${req}".`, "DBA Expert");
            out.innerHTML = marked.parse(res);
        }

        // --- DEMO AI ASSISTANT ---
        async function generateDemoSQL() {
            const outContainer = document.getElementById('demo-ai-result-container');
            const out = document.getElementById('demo-ai-output');
            const req = document.getElementById('demo-ai-input').value;
            
            if(!req.trim()) return;

            outContainer.classList.remove('hidden');
            out.innerHTML = '<span class="loading-dots">ƒêang vi·∫øt code</span>';
            
            // Get current schema
            const currentDb = alasql.useid;
            const tables = alasql(`SHOW TABLES FROM ${currentDb}`);
            let schemaInfo = `Database: ${currentDb}\n`;
            
            for(const t of tables) {
                const cols = alasql(`SHOW COLUMNS FROM ${t.tableid}`);
                schemaInfo += `Table ${t.tableid}: ${cols.map(c=>c.columnid).join(', ')}\n`;
            }

            const prompt = `
Context Schema:
${schemaInfo}

User Request: "${req}"

Task: Write a valid SQL query compatible with AlaSQL (standard SQL) to answer the request based on the schema above. 
Return ONLY the SQL code block. No explanation.
`;

            const res = await callGemini(prompt, "You are a SQL generator. Output only raw SQL code without markdown backticks if possible, or inside a sql block.");
            
            // Clean up result (remove markdown code blocks if any)
            let cleanSql = res.replace(/```sql/g, '').replace(/```/g, '').trim();
            out.innerText = cleanSql;
        }

        function runGeneratedSQL() {
            const sql = document.getElementById('demo-ai-output').innerText;
            if(!sql) return;
            insertSampleQuery(sql); // Re-use existing function to put in editor and run
        }

        // --- SQL DEMO ENGINE (AlaSQL) ---
        function initSQLDemo() {
            // Create Database & Tables
            alasql("CREATE DATABASE IF NOT EXISTS qlysinhvien");
            alasql("USE qlysinhvien");

            alasql("CREATE TABLE IF NOT EXISTS Lop (MaLop STRING, TenLop STRING)");
            alasql("CREATE TABLE IF NOT EXISTS SinhVien (MaSV STRING, HoTen STRING, NgaySinh DATE, GioiTinh STRING, MaLop STRING)");
            alasql("CREATE TABLE IF NOT EXISTS MonHoc (MaMH STRING, TenMH STRING, SoTinChi INT)");
            alasql("CREATE TABLE IF NOT EXISTS KetQua (MaSV STRING, MaMH STRING, Diem FLOAT)");

            // Check if data exists before inserting to avoid duplicates on re-run
            if (alasql("SELECT COUNT(*) as cnt FROM Lop")[0].cnt == 0) {
                alasql("INSERT INTO Lop VALUES ('L01', 'CNTT K15'), ('L02', 'Kinh Te K15'), ('L03', 'Ngon Ngu Anh')");
                alasql("INSERT INTO SinhVien VALUES ('SV01', 'Nguyen Van An', '2003-01-01', 'Nam', 'L01')");
                alasql("INSERT INTO SinhVien VALUES ('SV02', 'Tran Thi Binh', '2003-05-12', 'Nu', 'L01')");
                alasql("INSERT INTO SinhVien VALUES ('SV03', 'Le Van Cuong', '2002-11-20', 'Nam', 'L02')");
                alasql("INSERT INTO SinhVien VALUES ('SV04', 'Pham My Duyen', '2003-08-15', 'Nu', 'L02')");
                alasql("INSERT INTO SinhVien VALUES ('SV05', 'Hoang Van Em', '2003-02-10', 'Nam', 'L01')");
                alasql("INSERT INTO MonHoc VALUES ('MH01', 'Co so du lieu', 3), ('MH02', 'Lap trinh Java', 4), ('MH03', 'Toan roi rac', 3)");
                alasql("INSERT INTO KetQua VALUES ('SV01', 'MH01', 8.5), ('SV01', 'MH02', 9.0)");
                alasql("INSERT INTO KetQua VALUES ('SV02', 'MH01', 7.0), ('SV02', 'MH03', 8.0)");
                alasql("INSERT INTO KetQua VALUES ('SV03', 'MH02', 5.5)");
                alasql("INSERT INTO KetQua VALUES ('SV04', 'MH01', 9.5), ('SV04', 'MH03', 9.0)");
                alasql("INSERT INTO KetQua VALUES ('SV05', 'MH01', 4.0), ('SV05', 'MH02', 5.0)");
            }
            refreshSchemaViewer();
        }

        function refreshSchemaViewer() {
            const container = document.getElementById('schema-container');
            const dbSelector = document.getElementById('db-selector');
            const currentDb = alasql.useid;
            
            // Populate DB List
            const databases = alasql('SHOW DATABASES');
            dbSelector.innerHTML = '';
            databases.forEach(db => {
                const option = document.createElement('option');
                option.value = db.databaseid;
                option.text = db.databaseid;
                if (db.databaseid === currentDb) option.selected = true;
                dbSelector.appendChild(option);
            });

            container.innerHTML = '';

            const tables = alasql(`SHOW TABLES FROM ${currentDb}`);
            
            if (tables.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 italic text-center p-4">Ch∆∞a c√≥ b·∫£ng n√†o. <br>H√£y t·∫°o b·∫£ng ho·∫∑c nh·∫≠p d·ªØ li·ªáu.</div>';
                return;
            }

            tables.forEach(t => {
                const tableName = t.tableid;
                // AlaSQL SHOW COLUMNS returns array of column info
                const cols = alasql(`SHOW COLUMNS FROM ${tableName}`);
                
                let colsHtml = '';
                cols.forEach(c => {
                    let icon = 'text_fields';
                    let color = 'text-slate-400';
                    let cName = c.columnid;
                    
                    if (cName.toLowerCase().includes('id') || cName.toLowerCase().includes('ma')) {
                        icon = 'vpn_key';
                        color = 'text-yellow-600';
                    }
                    if (cName.toLowerCase().includes('date') || cName.toLowerCase().includes('ngay')) {
                        icon = 'calendar_today';
                    }
                    
                    colsHtml += `<div class="flex items-center gap-1"><span class="material-symbols-outlined text-[12px] ${color}">${icon}</span> ${cName} <span class="text-[9px] text-slate-300 ml-auto">${c.dbtypeid || ''}</span></div>`;
                });

                const html = `
                    <div class="border border-slate-200 rounded-lg overflow-hidden group">
                        <button onclick="insertSampleQuery('SELECT * FROM ${tableName}')" class="w-full text-left p-2 bg-slate-50 hover:bg-indigo-50 text-xs font-bold text-slate-700 border-b border-slate-200 flex justify-between items-center transition">
                            <span>üìÇ ${tableName}</span>
                            <span class="material-symbols-outlined text-base opacity-50 group-hover:text-indigo-600">play_arrow</span>
                        </button>
                        <div class="p-2 text-[11px] text-slate-600 space-y-1 bg-white">
                            ${colsHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function createNewDB() {
            const name = prompt("Nh·∫≠p t√™n CSDL m·ªõi (vi·∫øt li·ªÅn, kh√¥ng d·∫•u):", "new_db");
            if (name) {
                try {
                    // Sanitize name simple check
                    if(/[^a-zA-Z0-9_]/.test(name)) {
                        alert("T√™n CSDL ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi.");
                        return;
                    }
                    alasql(`CREATE DATABASE ${name}`);
                    alasql(`USE ${name}`);
                    refreshSchemaViewer();
                    showToast(`ƒê√£ t·∫°o v√† chuy·ªÉn sang: ${name}`);
                    document.getElementById('sql-editor').value = `CREATE TABLE ViDu (ID INT, Ten STRING);\nINSERT INTO ViDu VALUES (1, 'Hello');\nSELECT * FROM ViDu;`;
                } catch(e) {
                    alert("L·ªói: " + e.message);
                }
            }
        }
        
        function switchDB(dbName) {
            try {
                alasql(`USE ${dbName}`);
                refreshSchemaViewer();
                showToast(`ƒê√£ chuy·ªÉn sang: ${dbName}`);
            } catch(e) {
                alert("L·ªói chuy·ªÉn DB: " + e.message);
            }
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const sql = e.target.result;
                try {
                    // Try to detect if USE statement exists, otherwise execute on current DB
                    // AlaSQL handles multiple statements if separated by semicolon
                    alasql(sql); 
                    refreshSchemaViewer();
                    showToast("ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!");
                    document.getElementById('row-count').innerText = "Import xong";
                    document.getElementById('query-result-container').innerHTML = '<div class="p-4 text-green-600 font-mono text-sm">D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c n·∫°p v√†o h·ªá th·ªëng.</div>';
                } catch(err) {
                    alert("L·ªói nh·∫≠p file: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function exportDB() {
            const currentDb = alasql.useid;
            let sql = `-- Export CSDL: ${currentDb}\n-- Time: ${new Date().toLocaleString()}\n\nCREATE DATABASE IF NOT EXISTS ${currentDb};\nUSE ${currentDb};\n\n`;
            
            const tables = alasql(`SHOW TABLES FROM ${currentDb}`);
            
            tables.forEach(t => {
                const tableName = t.tableid;
                
                // 1. Create Table (Simplified reconstruction)
                const cols = alasql.databases[currentDb].tables[tableName].columns; 
                if(cols && cols.length > 0) {
                     const colDefs = cols.map(c => `${c.columnid} ${c.dbtypeid || 'STRING'}`).join(', ');
                     sql += `CREATE TABLE IF NOT EXISTS ${tableName} (${colDefs});\n`;
                } else {
                     // If defined without columns (standard AlaSQL behavior allowing schemaless)
                     // We try to infer or just skip CREATE for now, but usually for SQL export we need it.
                     // We'll skip precise CREATE if no metadata found.
                }

                // 2. Insert Data
                const data = alasql(`SELECT * FROM ${tableName}`);
                if (data.length > 0) {
                    data.forEach(row => {
                        const values = Object.values(row).map(v => {
                            if (typeof v === 'string') return `'${v.replace(/'/g, "''")}'`; 
                            if (v instanceof Date) return `'${v.toISOString().slice(0,10)}'`; 
                            return v;
                        }).join(', ');
                        sql += `INSERT INTO ${tableName} VALUES (${values});\n`;
                    });
                }
                sql += '\n';
            });

            const blob = new Blob([sql], { type: 'text/sql' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentDb}_backup.sql`;
            a.click();
        }

        function runDemoQuery() {
            const query = document.getElementById('sql-editor').value;
            const resContainer = document.getElementById('query-result-container');
            const rowCount = document.getElementById('row-count');
            
            try {
                const res = alasql(query);
                
                // If the query was a CREATE/INSERT/UPDATE/USE, refreshes might be needed
                if(query.toUpperCase().includes('CREATE') || query.toUpperCase().includes('DROP') || query.toUpperCase().includes('USE')) {
                    refreshSchemaViewer();
                }

                // Handle empty result or non-array result
                if (!res || !Array.isArray(res)) {
                    resContainer.innerHTML = '<div class="p-4 text-green-600 font-mono text-sm">Query executed successfully (No Rows Returned).</div>';
                    rowCount.innerText = "0 d√≤ng";
                    return;
                }

                if (res.length === 0) {
                     resContainer.innerHTML = '<div class="p-4 text-slate-500 font-mono text-sm italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</div>';
                     rowCount.innerText = "0 d√≤ng";
                     return;
                }

                // Handle AlaSQL multiple statements result (returns array of arrays)
                let dataToRender = res;
                if (Array.isArray(res[0])) {
                    dataToRender = res[res.length - 1]; // Show last result
                }

                if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
                     resContainer.innerHTML = '<div class="p-4 text-green-600 font-mono text-sm">Command Executed.</div>';
                     rowCount.innerText = "-";
                     return;
                }

                // Render Table
                const cols = Object.keys(dataToRender[0]);
                let html = '<table class="sql-result-table"><thead><tr>';
                cols.forEach(c => html += `<th>${c}</th>`);
                html += '</tr></thead><tbody>';
                
                dataToRender.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => html += `<td>${row[c]}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                
                resContainer.innerHTML = html;
                rowCount.innerText = `${dataToRender.length} d√≤ng`;

            } catch (e) {
                resContainer.innerHTML = `<div class="p-4 text-red-600 font-mono text-sm"><strong>L·ªói c√∫ ph√°p:</strong><br>${e.message}</div>`;
                rowCount.innerText = "L·ªói";
            }
        }

        function insertSampleQuery(q) {
            document.getElementById('sql-editor').value = q;
            runDemoQuery();
        }

        document.addEventListener('DOMContentLoaded', () => {
            scrollToSection('ddl');
            initSQLDemo();
        });
    </script>
</body>
</html>
